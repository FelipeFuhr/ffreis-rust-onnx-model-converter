name: Examples

on:
  pull_request:
    branches: [ main ]
    paths:
      - "examples/**"
      - "container/**"
      - "src/**"
      - "pyproject.toml"
      - "uv.lock"
      - "Makefile"
      - ".github/workflows/examples.yml"
  push:
    branches: [ main ]
    paths:
      - "examples/**"
      - "container/**"
      - "src/**"
      - "pyproject.toml"
      - "uv.lock"
      - "Makefile"
      - ".github/workflows/examples.yml"
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  examples:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v6

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f
      - name: Build and run examples
        run: |
          set -euo pipefail

          base_image="$(grep '^BASE_IMAGE=' container/digests.env | cut -d= -f2)"
          base_digest="$(grep '^BASE_DIGEST=' container/digests.env | cut -d= -f2)"

          docker build -f container/Dockerfile.base \
            -t ffreis/base \
            -t ffreis/base:local \
            -t localhost/ffreis/base:local \
            --build-arg BASE_IMAGE="${base_image}" \
            --build-arg BASE_DIGEST="${base_digest}" .
          docker build -f container/Dockerfile.base-runner -t ffreis/base-runner:local .
          docker build -f container/examples/Dockerfile.example-base -t onnx-converter/examples-base:local .

          fast_examples=(
            "container/examples/Dockerfile.example-sklearn example-sklearn"
            "container/examples/Dockerfile.example-compare-sklearn example-compare-sklearn"
            "container/examples/Dockerfile.example-sklearn-custom-cli example-sklearn-custom-cli"
            "container/examples/Dockerfile.example-pytorch example-pytorch"
            "container/examples/Dockerfile.example-tensorflow example-tensorflow"
            "container/examples/Dockerfile.example-optuna-sklearn example-optuna-sklearn"
          )

          for entry in "${fast_examples[@]}"; do
            dockerfile="${entry%% *}"
            image="${entry##* }"
            echo "Building ${image} from ${dockerfile}"
            docker build -f "${dockerfile}" -t "${image}" .
            echo "Running ${image}"
            docker run --rm "${image}"
          done

  autosklearn-examples:
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f
      - name: Build and run autosklearn examples
        run: |
          set -euo pipefail

          base_image="$(grep '^BASE_IMAGE=' container/digests.env | cut -d= -f2)"
          base_digest="$(grep '^BASE_DIGEST=' container/digests.env | cut -d= -f2)"

          docker build -f container/Dockerfile.base \
            -t ffreis/base \
            -t ffreis/base:local \
            -t localhost/ffreis/base:local \
            --build-arg BASE_IMAGE="${base_image}" \
            --build-arg BASE_DIGEST="${base_digest}" .
          docker build -f container/Dockerfile.base-runner -t ffreis/base-runner:local .
          docker build -f container/examples/Dockerfile.example-base -t onnx-converter/examples-base:local .

          autosklearn_examples=(
            "container/examples/Dockerfile.example-autosklearn1 example-autosklearn-v1"
            "container/examples/Dockerfile.example-autosklearn2 example-autosklearn-v2"
          )

          for entry in "${autosklearn_examples[@]}"; do
            dockerfile="${entry%% *}"
            image="${entry##* }"
            echo "Building ${image} from ${dockerfile}"
            docker build -f "${dockerfile}" -t "${image}" .
            echo "Running ${image}"
            docker run --rm "${image}"
          done
