name: Container Vulnerability Scan (Grype)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "container/**"
      - "container/digests.env"
      - "Makefile"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/grype.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "container/**"
      - "container/digests.env"
      - "Makefile"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/grype.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  grype:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Podman
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build images (local)
        run: |
          set -euo pipefail
          CONTAINER_COMMAND=podman PYTHON_VERSION=3.13 make build

      - name: Install Grype
        run: |
          set -euo pipefail

          PINNED_COMMIT="c6a67581ab4e7aa494351b919326ad6606af3010"
          SCRIPT_URL="https://raw.githubusercontent.com/anchore/grype/${PINNED_COMMIT}/install.sh"

          mkdir -p ./bin
          curl --fail --show-error --silent --location \
            --proto '=https' --proto-redir '=https' \
            "$SCRIPT_URL" -o /tmp/grype-install.sh

          grep -q "grype" /tmp/grype-install.sh

          sh /tmp/grype-install.sh -b ./bin
          ./bin/grype version
      - name: Grype scan (SARIF)
        run: |
          set -euo pipefail
          mkdir -p grype-results

          images=(ffreis/base ffreis/base-runner ffreis/onnx-converter-uv-venv ffreis/onnx-converter-package ffreis/onnx-converter-cli)

          for image in "${images[@]}"; do
            name="${image##*/}"
            out="grype-results/${name}.sarif"

            ./bin/grype "podman:${image}" -o sarif --file "$out" --fail-on high

            test -s "$out"
          done
      - name: Upload Grype SARIF (per image)
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(grype-results/*.sarif)
          if [ ${#files[@]} -eq 0 ]; then
            echo "::warning::No Grype SARIF files found to upload."
            exit 0
          fi
          failures=0
          for f in "${files[@]}"; do
            name="$(basename "$f" .sarif)"
            echo "Uploading $f with category grype-$name"

            sarif_payload="$(gzip -c "$f" | base64 | tr -d '\n')"

            if ! response="$(gh api \
              -X POST \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -f sarif="${sarif_payload}" \
              -f commit_sha="${{ github.sha }}" \
              -f ref="${{ github.ref }}" 2>&1)"; then
              failures=$((failures + 1))
              echo "::warning title=Grype SARIF upload failed::${f}: ${response}"
              continue
            fi
            echo "${response}"
          done
          if [ "$failures" -gt 0 ]; then
            echo "::warning::${failures} Grype SARIF upload(s) failed; vulnerability scan results were still generated."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
